name: Block direct pushes to main

on:
  push:
    branches: ["main"]

jobs:
  detect-direct-push:
    runs-on: ubuntu-latest
    steps:
      - name: Check commit message
        id: check
        run: |
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Determine if merge commit
        id: is_merge
        run: |
          msg="${{ github.event.head_commit.message }}"
          actor="${{ github.actor }}"
          # Allow maintainer (souhaibtouati) to push directly
          if [ "$actor" = "souhaibtouati" ]; then
            echo "merge=true" >> $GITHUB_OUTPUT
            echo "Maintainer push - allowed"
          elif echo "$msg" | grep -q "Merge pull request"; then
            echo "merge=true" >> $GITHUB_OUTPUT
          else
            echo "merge=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for direct push and notify maintainer
        if: steps.is_merge.outputs.merge == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = `Direct push to main detected: ${context.sha.slice(0,7)}`;
            const body = `A direct push to the 'main' branch was detected:\n\n- Pusher: @${context.actor}\n- Commit: ${context.sha}\n\nThis repository requires that all changes to 'main' be made via pull requests. Please open a PR to merge changes and revert direct pushes if necessary.\n\nMaintainer: @souhaibtouati`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['direct-push']
            });
